<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expenses</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen pb-24">

    <div class="max-w-md mx-auto p-4 space-y-4">

        <h1 class="text-xl font-bold flex items-center gap-2">
            <span class="material-icons-round text-blue-600">account_balance_wallet</span>
            Daily Expense
        </h1>

        <input id="whatsappNumber" class="w-full h-12 px-3 rounded-xl border" value="+254762634893">

        <input id="amountReceived" type="number" class="w-full h-12 px-3 rounded-xl border"
            placeholder="Amount Received">

        <!-- Summary -->
        <div class="bg-blue-600 text-white rounded-xl p-4">
            <p class="text-sm">Remaining Balance</p>
            <h2 id="balanceDisplay" class="text-3xl font-bold">0</h2>
            <p class="text-sm mt-1">Spent: <span id="spentDisplay">0</span></p>
            <div class="h-2 bg-white/30 rounded mt-3 overflow-hidden">
                <div id="progressBar" class="h-full bg-green-400 w-0 transition-all duration-700"></div>
            </div>
        </div>

        <!-- Add item -->
        <div class="relative">
            <div class="flex gap-2">
                <input id="itemName" class="flex-1 h-12 px-3 rounded-xl border"
                    placeholder="Andika kitu... (nyanya, viazi)">
                <input id="itemPrice" type="number" class="w-24 h-12 px-3 rounded-xl border" placeholder="Price">
                <button onclick="addItem()"
                    class="h-12 w-12 bg-blue-600 text-white rounded-xl flex items-center justify-center">
                    <span class="material-icons-round">add</span>
                </button>
            </div>

            <!-- Suggestions -->
            <ul id="suggestions"
                class="absolute z-10 w-full bg-white rounded-xl shadow mt-1 hidden max-h-48 overflow-y-auto"></ul>
        </div>

        <ul id="itemsList" class="space-y-2"></ul>

        <textarea id="messageBox" class="w-full h-24 p-3 rounded-xl border" readonly></textarea>

        <button onclick="generateAndSend()"
            class="fixed bottom-6 right-6 bg-blue-600 text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-2">
            <span class="material-icons-round">whatsapp</span>
            Send Report
        </button>

    </div>

    <script>
        /* =============================
           SMART LEARNING AUTOCOMPLETE
        ============================= */

        // Default food & daily items
        const defaultItems = [
            "nyanya", "viazi", "vitunguu", "nyama", "meat", "milk", "maziwa",
            "cabbage", "sukuma", "rice", "beans", "unga", "eggs", "mayai",
            "salt", "sugar", "mafuta", "cooking oil",
            "soap", "sabuni", "soldier", "gate", "guard", "zucchini", "cogette"
        ];

        let learnedItems = JSON.parse(localStorage.getItem("learnedItems")) || {};
        defaultItems.forEach(i => learnedItems[i] ??= 1);

        function saveLearned() {
            localStorage.setItem("learnedItems", JSON.stringify(learnedItems));
        }

        /* =============================
           EXPENSE LOGIC
        ============================= */

        let items = JSON.parse(localStorage.getItem("items")) || [];
        let spent = JSON.parse(localStorage.getItem("spent")) || 0;

        render();

        function addItem() {
            const name = itemName.value.trim().toLowerCase();
            const price = Number(itemPrice.value);

            if (!name || price <= 0) return;

            items.push({ name, price });
            spent += price;

            learnedItems[name] = (learnedItems[name] || 0) + 1;
            saveLearned();

            itemName.value = "";
            itemPrice.value = "";
            hideSuggestions();

            save();
            render();
        }

        function deleteItem(index) {
            spent -= items[index].price;
            items.splice(index, 1);
            save();
            render();
        }

        function render() {
            itemsList.innerHTML = "";
            items.forEach((item, i) => {
                const li = document.createElement("li");
                li.className = "bg-white p-3 rounded-xl shadow flex justify-between";
                li.innerHTML = `
      <span>${item.name} - <b>${item.price}</b></span>
      <button onclick="deleteItem(${i})" class="text-red-500">
        <span class="material-icons-round">delete</span>
      </button>`;
                itemsList.appendChild(li);
            });

            updateSummary();
        }

        function updateSummary() {
            const total = Number(amountReceived.value) || 0;
            spentDisplay.textContent = spent;
            balanceDisplay.textContent = total - spent;
            progressBar.style.width = total ? Math.min(spent / total * 100, 100) + "%" : "0%";
        }

        function save() {
            localStorage.setItem("items", JSON.stringify(items));
            localStorage.setItem("spent", JSON.stringify(spent));
        }

        function generateAndSend() {
            const number = whatsappNumber.value.replace(/\D/g, "");
            let msg = "RIPOTI YA MATUMIZI\n\n";
            items.forEach(i => msg += `${i.name}: ${i.price}\n`);
            msg += `\nJumla: ${spent}`;
            msg += `\nImebaki: ${(Number(amountReceived.value) || 0) - spent}`;

            messageBox.value = msg;
            window.open(`https://wa.me/${number}?text=${encodeURIComponent(msg)}`);
        }

        /* =============================
           AUTOCOMPLETE UI
        ============================= */

        itemName.addEventListener("input", () => {
            const q = itemName.value.toLowerCase();
            if (!q) return hideSuggestions();

            const matches = Object.keys(learnedItems)
                .filter(i => i.includes(q))
                .sort((a, b) => learnedItems[b] - learnedItems[a])
                .slice(0, 6);

            suggestions.innerHTML = "";
            matches.forEach(m => {
                const li = document.createElement("li");
                li.className = "px-4 py-2 hover:bg-gray-100 cursor-pointer";
                li.textContent = m;
                li.onclick = () => {
                    itemName.value = m;
                    hideSuggestions();
                };
                suggestions.appendChild(li);
            });

            suggestions.classList.toggle("hidden", matches.length === 0);
        });

        function hideSuggestions() {
            suggestions.classList.add("hidden");
        }

        document.addEventListener("click", e => {
            if (!e.target.closest("#itemName")) hideSuggestions();
        });
    </script>

</body>

</html>